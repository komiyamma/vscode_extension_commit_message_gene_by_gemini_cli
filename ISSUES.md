# プロジェクトの問題点分析

このドキュメントは、`commit-message-gene-by-gemini-cli` プロジェクトの現状のソースコードを分析し、特定された主な問題点と潜在的なリスクをまとめたものです。

---

## 1. プラットフォーム依存 (Windows限定)

### 現状
この拡張機能は、中核的な処理をC#で記述されコンパイルされた `gemini_proxy.exe` というWindows実行ファイルに依存しています。そのため、macOSやLinuxといった他のOSでは動作しません。

### 影響と改善案
- **影響:** 利用できるユーザーがWindowsユーザーに限定されてしまいます。
- **改善案:** `gemini_proxy.exe` が担っている処理（`gemini.cmd` のパス探索、コマンド実行、エンコーディング制御、コンソール非表示）は、すべてNode.jsの標準APIやライブラリで代替可能です。TypeScriptのみでロジックを再実装することで、クロスプラットフォーム対応を実現できます。

## 2. 外部ツールへの強い依存

### 現状
`gemini.cmd` が `npm` を通じてグローバルにインストールされていることが、拡張機能の動作の前提となっています。

### 影響と改善案
- **影響:** ユーザー側での環境構築の手間が増え、`npm` の設定や環境変数 `Path` の問題など、ユーザー環境に起因するトラブルが発生しやすくなります。
- **改善案:** 拡張機能に `gemini` のnpmパッケージを同梱するか、初回の実行時にインストールを促すガイド機能を追加することで、ユーザーの負担を軽減できます。

## 3. AIとの不安定な通信方法

### 現状
AI（Gemini）との連携において、自然言語のプロンプトで出力形式を細かく指示し、その結果から `■★■★■` と `▲★▲★▲` という特殊なマーカー文字列を目印にコミットメッセージを抽出しています。

### 影響と改善案
- **影響:** この方法は、AIモデルのバージョンアップや振る舞いの変化に対して非常に脆弱です。AIが少しでも指示と異なる応答を返した場合、メッセージの抽出に失敗し、機能しなくなります。これは極めて不安定な実装です。
- **改善案:** AIの機能を呼び出す際に、JSONモードなどの構造化されたデータを返すオプションを指定することを検討します。構造化データを利用すれば、特定の文字列に依存することなく、安定的かつ確実に結果をパースできます。

## 4. 複雑なプロセス管理ロジック

### 現状
TypeScript側のコード (`src/extension.ts`) には、外部プロセス (`gemini_proxy.exe`) の多重起動を防止したり、応答がない場合に強制終了させたりするための複雑なロジックが含まれています。

### 影響と改善案
- **影響:** コードの可読性とメンテナンス性を著しく下げています。この複雑なロジック自体が、将来的に新たなバグの原因となる可能性があります。
- **改善案:** 問題1のクロスプラットフォーム化と合わせて、Node.jsの `async/await` をベースとしたシンプルな非同期処理に書き換えることで、この複雑なプロセス管理ロジックを不要にできる可能性があります。

## 5. ドキュメントと実装の乖離

### 現状
`README.ja.md` には、`gemini.cmd` のパスが `%APPDATA%\npm\gemini.cmd` にあると記載されていますが、実際の `gemini_proxy.exe` の実装では、`npm config get prefix` コマンドを使ってより動的にパスを探索する、より優れたロジックが採用されています。

### 影響と改善案
- **影響:** ドキュメントの情報が古いため、ユーザーがトラブルシューティングを行う際に混乱を招く恐れがあります。
- **改善案:** READMEの記述を、現在の実装に即した内容（`npm config get prefix` を優先的に参照する点など）に修正します。

## 6. 中核ロジックのテスト不足

### 現状
プロジェクトにはテストを実行する仕組み (`npm test`) が存在しますが、拡張機能の最も重要かつ不安定な部分である「`gemini.cmd` を呼び出し、AIと連携してコミットメッセージを生成・抽出する」という一連の中核ロジックに対する自動テストがありません。

### 影響と改善案
- **影響:** 将来的な機能改善やリファクタリングの際に、意図しない不具合（デグレード）が発生しても検知することが困難です。これにより、拡張機能の品質と安定性の維持が難しくなります。
- **改善案:** `gemini.cmd` の呼び出し部分をモック化した単体テストや、実際にAIとの通信を行う結合テストを整備することが望まれます。
